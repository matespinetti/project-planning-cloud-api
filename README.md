# ProjectPlanning Cloud Persistence API

A FastAPI-based Cloud Persistence API that handles all database operations for the ProjectPlanning system. This standalone REST API uses PostgreSQL to store project data and is designed to be called by the Proxy API.

## Features

- **Async SQLAlchemy 2.0** with asyncpg driver for optimal performance
- **UUID Primary Keys** - Auto-generated by database
- **Automatic Timestamps** - `created_at` and `updated_at` managed automatically
- **Nested Creates** - Create projects with etapas and pedidos in a single transaction
- **Eager Loading** - Optimized queries with joinedload to avoid N+1 queries
- **Cascade Deletes** - Deleting a project automatically deletes all nested entities
- **Partial Updates** - PATCH endpoints with `exclude_unset=True`
- **Comprehensive Validation** - Pydantic v2 with custom validators
- **CORS Support** - Configured for proxy API integration
- **Alembic Migrations** - Async-compatible database migrations
- **Docker Deployment** - PostgreSQL + API with health checks

## Architecture

```
┌─────────────────────┐
│  Proxy API          │
│  (Orchestration)    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Cloud API          │  ◄── This API
│  (Persistence)      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  PostgreSQL         │
│  Database           │
└─────────────────────┘
```

## Tech Stack

- **Framework:** FastAPI
- **Package Manager:** uv (modern Python package manager)
- **Python Version:** 3.12+
- **Server:** Uvicorn
- **Database:** PostgreSQL 15+
- **ORM:** SQLAlchemy 2.0 (async with asyncpg)
- **Migrations:** Alembic
- **Validation:** Pydantic v2
- **Deployment:** Docker + docker-compose

## Project Structure

```
project-planning-cloud-api/
├── pyproject.toml              # uv configuration with dependencies
├── Dockerfile
├── docker-compose.yml          # PostgreSQL + API
├── alembic.ini                 # Alembic configuration
├── .env.example
├── README.md
├── CLAUDE.md                   # Detailed specification
│
├── app/
│   ├── main.py                 # FastAPI app initialization
│   ├── config.py               # Pydantic Settings
│   │
│   ├── api/v1/
│   │   ├── router.py           # Main API router
│   │   └── endpoints/
│   │       └── projects.py     # CRUD endpoints for projects
│   │
│   ├── models/                 # SQLAlchemy ORM models
│   │   ├── proyecto.py         # Proyecto table
│   │   ├── etapa.py            # Etapa table
│   │   └── pedido.py           # Pedido table
│   │
│   ├── schemas/                # Pydantic schemas
│   │   ├── proyecto.py         # ProyectoCreate, ProyectoResponse, ProyectoUpdate
│   │   ├── etapa.py            # EtapaCreate, EtapaResponse
│   │   └── pedido.py           # PedidoCreate, PedidoResponse
│   │
│   ├── crud/
│   │   └── proyecto.py         # CRUD operations
│   │
│   └── db/
│       ├── base.py             # SQLAlchemy Base class
│       └── session.py          # Database session management
│
└── alembic/
    ├── env.py                  # Alembic async environment
    └── versions/               # Migration files
```

## API Endpoints

### POST /api/v1/projects
Create a new project with nested etapas and pedidos.

**Request:**
```json
{
  "titulo": "Community Center Construction",
  "descripcion": "Build a new community center with multiple facilities",
  "tipo": "Infrastructure",
  "pais": "Argentina",
  "provincia": "Buenos Aires",
  "ciudad": "La Plata",
  "barrio": "Centro",
  "estado": "en_planificacion",
  "bonita_case_id": null,
  "bonita_process_instance_id": null,
  "etapas": [
    {
      "nombre": "Phase 1 - Foundation",
      "descripcion": "Foundation and structural work",
      "fecha_inicio": "2024-01-01",
      "fecha_fin": "2024-03-31",
      "pedidos": [
        {
          "tipo": "economico",
          "descripcion": "Budget for foundation materials",
          "monto": 50000.00,
          "moneda": "ARS",
          "cantidad": null,
          "unidad": null
        }
      ]
    }
  ]
}
```

**Response (201 Created):**
Returns project with all generated UUIDs and timestamps.

### GET /api/v1/projects/{project_id}
Retrieve a project with all nested data (etapas and pedidos).

**Response (200 OK):**
Returns complete project structure with nested entities.

### PATCH /api/v1/projects/{project_id}
Partial update of a project (mainly for Bonita info).

**Request:**
```json
{
  "bonita_case_id": "12345",
  "bonita_process_instance_id": 67890
}
```

**Response (200 OK):**
Returns updated project with all nested data.

### DELETE /api/v1/projects/{project_id}
Delete a project (cascades to etapas and pedidos).

**Response (204 No Content)**

## Installation & Setup

### Prerequisites

- Python 3.12+
- [uv](https://github.com/astral-sh/uv) package manager
- PostgreSQL 15+ (or use Docker)

### Install uv

```bash
# Linux/macOS
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### Local Development Setup

1. **Clone the repository**
```bash
cd project-planning-cloud-api
```

2. **Install dependencies**
```bash
uv sync
```

3. **Configure environment**
```bash
cp .env.example .env
# Edit .env with your database credentials
```

4. **Start PostgreSQL** (if not using Docker)
```bash
# Install PostgreSQL 15+ and create database
createdb projectplanning_cloud
```

5. **Run database migrations**
```bash
# Create initial migration (first time only)
uv run alembic revision --autogenerate -m "Initial schema"

# Apply migrations
uv run alembic upgrade head

# Check current version
uv run alembic current
```

6. **Run development server**
```bash
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8001
```

7. **Access API documentation**
```
http://localhost:8001/docs
```

### Docker Setup

1. **Build and start services**
```bash
docker-compose up --build
```

2. **Run in background**
```bash
docker-compose up -d
```

3. **View logs**
```bash
docker-compose logs -f api
```

4. **Stop services**
```bash
docker-compose down
```

5. **Stop and remove volumes** (deletes database data)
```bash
docker-compose down -v
```

### Access Points

- **API:** http://localhost:8001
- **Swagger Docs:** http://localhost:8001/docs
- **Health Check:** http://localhost:8001/health
- **PostgreSQL:** localhost:5433 (external)

## Database Schema

### Tables

**proyectos** - Main project table
- `id` (UUID, PK)
- `titulo`, `descripcion`, `tipo`
- `pais`, `provincia`, `ciudad`, `barrio`
- `estado` (enum: borrador, en_planificacion, buscando_financiamiento, en_ejecucion, completo)
- `bonita_case_id`, `bonita_process_instance_id`
- `created_at`, `updated_at` (auto-managed)

**etapas** - Project stages
- `id` (UUID, PK)
- `proyecto_id` (UUID, FK → proyectos.id, CASCADE DELETE)
- `nombre`, `descripcion`
- `fecha_inicio`, `fecha_fin`

**pedidos** - Coverage requests
- `id` (UUID, PK)
- `etapa_id` (UUID, FK → etapas.id, CASCADE DELETE)
- `tipo` (enum: economico, materiales, mano_obra, transporte, equipamiento)
- `descripcion`
- `monto`, `moneda` (for economico type)
- `cantidad`, `unidad` (for other types)

### Relationships
- `proyectos` → `etapas` (One-to-Many, CASCADE DELETE)
- `etapas` → `pedidos` (One-to-Many, CASCADE DELETE)

## Development

### Running Tests
```bash
uv run pytest
```

### Database Migrations

**Create new migration:**
```bash
uv run alembic revision --autogenerate -m "Description of changes"
```

**Apply migrations:**
```bash
uv run alembic upgrade head
```

**Rollback one migration:**
```bash
uv run alembic downgrade -1
```

**View migration history:**
```bash
uv run alembic history
```

### Code Quality

The project follows these best practices:
- **Async/Await** - All database operations are async
- **Type Hints** - Full type annotations with SQLAlchemy 2.0 Mapped columns
- **Dependency Injection** - FastAPI's `Depends()` for session management
- **Eager Loading** - `joinedload()` to avoid N+1 queries
- **Transaction Management** - Atomic nested creates and updates
- **Error Handling** - Proper HTTP status codes and logging
- **Validation** - Comprehensive Pydantic validation

## Environment Variables

```bash
# Database
DATABASE_URL=postgresql://user:password@host:port/database

# API Settings
API_V1_PREFIX=/api/v1
PROJECT_NAME=ProjectPlanning Cloud Persistence API

# CORS (comma-separated origins)
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8000
```

## Common Commands

```bash
# Install dependencies
uv sync

# Run development server
uv run uvicorn app.main:app --reload --port 8001

# Run migrations
uv run alembic upgrade head

# Create migration
uv run alembic revision --autogenerate -m "message"

# Run tests
uv run pytest

# Docker build and run
docker-compose up --build

# Docker logs
docker-compose logs -f api

# Docker stop
docker-compose down
```

## Troubleshooting

### Database Connection Issues
- Ensure PostgreSQL is running
- Check DATABASE_URL in `.env`
- Verify PostgreSQL accepts connections (check `pg_hba.conf`)

### Migration Issues
- Make sure all models are imported in `alembic/env.py`
- Run migrations before starting the API
- Check Alembic version: `uv run alembic current`

### Docker Issues
- Check service health: `docker-compose ps`
- View logs: `docker-compose logs api`
- Rebuild: `docker-compose up --build`

## Success Criteria

✅ All 4 endpoints work correctly (POST, GET, PATCH, DELETE)
✅ UUIDs generated automatically by database
✅ Timestamps auto-managed
✅ Nested creates work
✅ Eager loading returns full nested structure
✅ Cascade deletes work
✅ PATCH updates only provided fields
✅ Alembic migrations run successfully
✅ Docker setup works
✅ Swagger docs accessible
✅ Error handling returns proper status codes
✅ Validation prevents invalid data

## License

This project is part of a college assignment for the ProjectPlanning system.

## Support

For detailed specifications and architecture decisions, see [CLAUDE.md](CLAUDE.md).
